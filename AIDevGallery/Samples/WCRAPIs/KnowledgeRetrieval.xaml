<?xml version="1.0" encoding="utf-8" ?>
<samples:BaseSamplePage
    x:Class="AIDevGallery.Samples.WCRAPIs.KnowledgeRetrieval"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:shared="using:AIDevGallery.Samples.SharedCode"
    xmlns:samples="using:AIDevGallery.Samples"
    mc:Ignorable="d">

    <Page.Resources>
        <shared:ChatTemplateSelector
             x:Key="ChatTemplateSelector"
             AssistantTemplate="{StaticResource AssistantDataTemplate}"
             UserTemplate="{StaticResource UserDataTemplate}" />
        <DataTemplate x:Key="UserDataTemplate" x:DataType="shared:Message">
            <StackPanel
                 MaxWidth="486"
                 Padding="12"
                 HorizontalAlignment="Right"
                 Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                 BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                 BorderThickness="1"
                 CornerRadius="{StaticResource OverlayCornerRadius}"
                 Spacing="8">
                <TextBlock
                     IsTextSelectionEnabled="True"
                     Text="{x:Bind Content, Mode=OneWay}"
                     TextWrapping="Wrap" />
            </StackPanel>
        </DataTemplate>
        <DataTemplate x:Key="AssistantDataTemplate" x:DataType="shared:Message">
            <Grid Margin="0,4" HorizontalAlignment="Left">
                <StackPanel MaxWidth="486" Spacing="4">
                    <Border
                         Background="Transparent"
                         BorderBrush="Transparent"
                         BorderThickness="0"
                         Padding="8"
                         x:Name="ThinkContainer"
                         x:Load="{x:Bind HasThink, Mode=OneWay}">
                        <TextBlock
                         IsTextSelectionEnabled="True"
                         Text="{x:Bind ThinkContent, Mode=OneWay}"
                         TextWrapping="Wrap"
                         Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                    </Border>
                    <StackPanel
                         Padding="12"
                         HorizontalAlignment="Left"
                         Background="{ThemeResource AccentFillColorDefaultBrush}"
                         BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                         BorderThickness="1"
                         CornerRadius="{StaticResource OverlayCornerRadius}"
                         Spacing="8">
                        <TextBlock
                         Foreground="{ThemeResource TextOnAccentFillColorPrimaryBrush}"
                         IsTextSelectionEnabled="True"
                         Text="{x:Bind DisplayContent, Mode=OneWay}"
                         TextWrapping="Wrap" />
                    </StackPanel>
                </StackPanel>
            </Grid>
        </DataTemplate>
    </Page.Resources>

    <Grid BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
      BorderThickness="0,0,0,1"
      Margin="-20"
      Padding="20">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="0.4*" MinWidth="200" />
        </Grid.ColumnDefinitions>
        <StackPanel Spacing="8">
            <TextBlock 
                Style="{StaticResource CaptionTextBlockStyle}" 
                Foreground="{ThemeResource TextFillColorSecondaryBrush}" 
                Text="Sample text data:"/>

            <Grid>
                <Button
                    Margin="3,0,0,0"
                    Click="AddTextDataButton_Click">
                    <StackPanel Orientation="Horizontal">
                        <FontIcon FontFamily="Segoe MDL2 Assets" Glyph="&#xE898;" FontSize="16" Margin="0,0,4,0"/>
                        <TextBlock Text="Add Text Data"/>
                    </StackPanel>
                </Button>
                <Button Style="{StaticResource SubtleButtonStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}" HorizontalAlignment="Right" Margin="3,0">
                    <Button.Content>
                        <FontIcon FontFamily="Segoe MDL2 Assets" Glyph="&#xE713;" FontSize="14"/>
                    </Button.Content>
                    <Button.Flyout>
                        <MenuFlyout>
                            <MenuFlyoutItem Text="Index All Manually" Click="IndexAllButton_Click" />
                        </MenuFlyout>
                    </Button.Flyout>
                </Button>
            </Grid>
            
            <ItemsView
                x:Name="textDataItemsView"
                ItemsSource="{x:Bind TextDataItems}"
                SelectionMode="None"
                IsItemInvokedEnabled="False"
                Grid.Column="0"
                Padding="0,0,0,12">
                <ItemsView.ItemTemplate>
                    <DataTemplate x:DataType="shared:TextDataItem">
                        <ItemContainer AutomationProperties.Name="{x:Bind Id}" Width="200" Margin="3" IsTabStop="False">
                            <Grid>
                                <TextBox Text="{x:Bind Value, Mode=TwoWay}"
                                    Tag="{x:Bind Id}"
                                    TextChanged="SemanticTextBox_TextChanged"
                                    AcceptsReturn="True"
                                    TextWrapping="Wrap"
                                    Padding="11,32,11,11"
                                    Height="120"/>
                                <Button
                                    x:Name="textCloseButton"
                                    Click="CloseButton_Click"
                                    Tag="{x:Bind}"
                                    HorizontalAlignment="Right"
                                    VerticalAlignment="Top"
                                    Margin="0,4,4,0"
                                    Background="Transparent"
                                    BorderThickness="0"
                                    Style="{StaticResource SubtleButtonStyle}">
                                    <FontIcon FontFamily="Segoe MDL2 Assets" Glyph="&#xE711;" FontSize="16"/>
                                </Button>

                                <TextBlock Text="{x:Bind Id}" HorizontalAlignment="Left" VerticalAlignment="Top" Margin="12,7" Style="{StaticResource BodyStrongTextBlockStyle}"/>
                            </Grid>
                        </ItemContainer>
                    </DataTemplate>
                </ItemsView.ItemTemplate>
                <ItemsView.Layout>
                    <StackLayout Orientation="Horizontal" />
                </ItemsView.Layout>
            </ItemsView>
        </StackPanel>

        <Grid Grid.Column="1" 
            Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" 
            BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
            BorderThickness="1,1,1,0"
            Margin="0,-20,-20,-20"
            Padding="20">

            <Grid MaxWidth="1000">
                <Grid.RowDefinitions>
                    <RowDefinition Height="*" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <ScrollViewer MaxHeight="345">
                    <ListView
                         x:Name="InvertedListView"
                         Padding="-12,0,-12,24"
                         ItemTemplateSelector="{StaticResource ChatTemplateSelector}"
                         ItemsSource="{x:Bind Messages}"
                         SelectionMode="None"
                         Loaded="InvertedListView_Loaded">
                        <ListView.ItemsPanel>
                            <ItemsPanelTemplate>
                                <ItemsStackPanel VerticalAlignment="Bottom" ItemsUpdatingScrollMode="KeepLastItemInView" />
                            </ItemsPanelTemplate>
                        </ListView.ItemsPanel>
                        <ListView.ItemContainerStyle>
                            <Style TargetType="ListViewItem">
                                <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                            </Style>
                        </ListView.ItemContainerStyle>
                    </ListView>
                </ScrollViewer>

                <Grid Grid.Row="1" ColumnSpacing="8">
                    <TextBox
                        x:Name="InputBox"
                        Grid.Row="1"
                        AutomationProperties.Name="Prompt input"
                        KeyUp="TextBox_KeyUp"
                        PreviewKeyDown="TextBox_PreviewKeyDown"
                        PlaceholderText="Ask about the sample data e.g., 'What ingredients do I need for soup?'"
                        TextChanged="InputBox_TextChanged"
                        TextWrapping="Wrap" 
                        AcceptsReturn="True"
                        MaxHeight="148"
                        Padding="7,7,60,7"
                        ScrollViewer.VerticalScrollBarVisibility="Auto"/>
                    <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Top" Margin="8">
                        <Button x:Name="SendBtn"
                            AutomationProperties.Name="Send Message"
                            Click="SendBtn_Click"
                            Style="{StaticResource AccentButtonStyle}"
                            IsEnabled="False">
                            <FontIcon FontSize="16"
                              Glyph="&#xE725;" />
                        </Button>
                        <Button x:Name="StopBtn"
                            AutomationProperties.Name="Stop"
                            Click="StopBtn_Click"
                            Style="{ThemeResource AccentButtonStyle}"
                            Visibility="Collapsed">
                            <StackPanel Orientation="Horizontal"
                                Spacing="8">
                                <FontIcon FontSize="16"
                                    Glyph="&#xE73B;" />
                            </StackPanel>
                        </Button>
                    </StackPanel>

                </Grid>

                <Grid HorizontalAlignment="Stretch" VerticalAlignment="Top">
                    <StackPanel Spacing="7">
                        <InfoBar
                            x:Name="IndexingMessage"
                            IsOpen="False"
                            Severity="Informational"
                            Title="Indexing"
                            Message="Partial results may be available." 
                            Padding="0"/>
                        <InfoBar
                            x:Name="RemovedItemMessage"
                            IsOpen="False"
                            Severity="Informational"
                            Message="Item has been removed" 
                            Padding="0"/>
                    </StackPanel>
                </Grid>
            </Grid>
        </Grid>
    </Grid>
</samples:BaseSamplePage>
