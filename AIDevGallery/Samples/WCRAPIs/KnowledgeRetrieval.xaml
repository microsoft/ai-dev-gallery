<?xml version="1.0" encoding="utf-8" ?>
<samples:BaseSamplePage
    x:Class="AIDevGallery.Samples.WCRAPIs.KnowledgeRetrieval"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:controls="using:Microsoft.UI.Xaml.Controls"
    xmlns:shared="using:AIDevGallery.Samples.SharedCode"
    xmlns:samples="using:AIDevGallery.Samples"
    mc:Ignorable="d">

    <Page.Resources>
        <shared:ChatTemplateSelector
             x:Key="ChatTemplateSelector"
             AssistantTemplate="{StaticResource AssistantDataTemplate}"
             UserTemplate="{StaticResource UserDataTemplate}" />
        <DataTemplate x:Key="UserDataTemplate" x:DataType="shared:Message">
            <StackPanel
             MaxWidth="486"
             Padding="12"
             HorizontalAlignment="Right"
             Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
             BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
             BorderThickness="1"
             CornerRadius="{StaticResource OverlayCornerRadius}"
             Spacing="8">
                <TextBlock
                 IsTextSelectionEnabled="True"
                 Text="{x:Bind Content, Mode=OneWay}"
                 TextWrapping="Wrap" />
                <TextBlock
                 HorizontalAlignment="Right"
                 Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                 Style="{StaticResource CaptionTextBlockStyle}"
                 Text="{x:Bind MsgDateTime}" />
            </StackPanel>
        </DataTemplate>
        <DataTemplate x:Key="AssistantDataTemplate" x:DataType="shared:Message">
            <Grid Margin="0,4" HorizontalAlignment="Left">
                <StackPanel MaxWidth="486" Spacing="4">
                    <Border
                     Background="Transparent"
                     BorderBrush="Transparent"
                     BorderThickness="0"
                     Padding="8"
                     x:Name="ThinkContainer"
                     x:Load="{x:Bind HasThink, Mode=OneWay}">
                        <TextBlock
                         IsTextSelectionEnabled="True"
                         Text="{x:Bind ThinkContent, Mode=OneWay}"
                         TextWrapping="Wrap"
                         Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                    </Border>
                    <StackPanel
                     Padding="12"
                     HorizontalAlignment="Left"
                     Background="{ThemeResource AccentFillColorDefaultBrush}"
                     BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                     BorderThickness="1"
                     CornerRadius="{StaticResource OverlayCornerRadius}"
                     Spacing="8">
                        <TextBlock
                         Foreground="{ThemeResource TextOnAccentFillColorPrimaryBrush}"
                         IsTextSelectionEnabled="True"
                         Text="{x:Bind DisplayContent, Mode=OneWay}"
                         TextWrapping="Wrap" />
                        <TextBlock
                         Foreground="{ThemeResource TextOnAccentFillColorPrimaryBrush}"
                         Style="{StaticResource CaptionTextBlockStyle}"
                         Text="{x:Bind MsgDateTime}" />
                    </StackPanel>
                </StackPanel>
            </Grid>
        </DataTemplate>
    </Page.Resources>

    <Grid BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
      BorderThickness="0,0,0,1"
      Margin="-20"
      Padding="20">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="0.3*" MinWidth="200" />
        </Grid.ColumnDefinitions>
        <StackPanel Spacing="8">
            <TextBlock 
                Style="{StaticResource CaptionTextBlockStyle}" 
                Foreground="{ThemeResource TextFillColorSecondaryBrush}" 
                Text="Sample text data:"/>
            <Button
                Grid.Column="1"
                Margin="3,0,0,0"
                Click="AddTextDataButton_Click">
                <StackPanel Orientation="Horizontal">
                    <FontIcon FontFamily="Segoe MDL2 Assets" Glyph="&#xE898;" FontSize="16" Margin="0,0,4,0"/>
                    <TextBlock Text="Add Text Data"/>
                </StackPanel>
            </Button>
            <controls:ItemsView
                x:Name="textDataItemsView"
                ItemsSource="{x:Bind TextDataItems}"
                SelectionMode="None"
                IsItemInvokedEnabled="False"
                Grid.Column="0"
                Padding="0,0,0,12">
                <controls:ItemsView.ItemTemplate>
                    <DataTemplate x:DataType="shared:TextDataItem">
                        <controls:ItemContainer AutomationProperties.Name="{x:Bind Id}" Width="200" Margin="3">
                            <Grid>
                                <TextBox Text="{x:Bind Value, Mode=TwoWay}"
                                    Tag="{x:Bind Id}"
                                    TextChanged="SemanticTextBox_TextChanged"
                                    AcceptsReturn="True"
                                    TextWrapping="Wrap"
                                    Padding="11,32,11,11"
                                    Height="120"/>
                                <Button
                                    x:Name="textCloseButton"
                                    Click="closeButton_Click"
                                    Tag="{x:Bind}"
                                    HorizontalAlignment="Right"
                                    VerticalAlignment="Top"
                                    Margin="0,4,4,0"
                                    Background="Transparent"
                                    BorderThickness="0"
                                    Style="{StaticResource SubtleButtonStyle}">
                                    <FontIcon FontFamily="Segoe MDL2 Assets" Glyph="&#xE711;" FontSize="16"/>
                                </Button>

                                <TextBlock Text="{x:Bind Id}" HorizontalAlignment="Left" VerticalAlignment="Top" Margin="12,7" Style="{StaticResource BodyStrongTextBlockStyle}"/>
                            </Grid>
                        </controls:ItemContainer>
                    </DataTemplate>
                </controls:ItemsView.ItemTemplate>
                <controls:ItemsView.Layout>
                    <StackLayout Orientation="Horizontal" />
                </controls:ItemsView.Layout>
            </controls:ItemsView>

            <TextBlock Style="{StaticResource CaptionTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}" Text="Sample image data:" />
            <Button
                Grid.Column="1"
                VerticalAlignment="Top"
                Margin="3,0,0,0"
                Click="UploadImageButton_Click">
                <StackPanel Orientation="Horizontal">
                    <FontIcon FontFamily="Segoe MDL2 Assets" Glyph="&#xE898;" FontSize="16" Margin="0,0,4,0"/>
                    <TextBlock Text="Add Image Data"/>
                </StackPanel>
            </Button>
            <controls:ItemsView
                x:Name="ImageDataItemsView"
                ItemsSource="{x:Bind ImageDataItems}"
                SelectionMode="None"
                IsItemInvokedEnabled="False"
                Grid.Column="0">
                <controls:ItemsView.ItemTemplate>
                    <DataTemplate x:DataType="shared:ImageDataItem">
                        <controls:ItemContainer AutomationProperties.Name="{x:Bind Id}" Width="200" Margin="3">
                            <Grid>
                                <Image Source="{x:Bind ImageSource}"
                                    Tag="{x:Bind Id}"
                                    ImageOpened="ImageData_ImageOpened" 
                                    Stretch="Fill" 
                                    HorizontalAlignment="Stretch" 
                                    VerticalAlignment="Stretch" 
                                    MinWidth="70"/>
                                <Border Background="{ThemeResource LayerFillColorAltBrush}" Height="34" VerticalAlignment="Top" />
                                <Button
                                x:Name="imageCloseButton"
                                Click="closeButton_Click"
                                Tag="{x:Bind}"
                                HorizontalAlignment="Right"
                                VerticalAlignment="Top"
                                Margin="0,4,4,0"
                                Background="Transparent"
                                BorderThickness="0"
                                Style="{StaticResource SubtleButtonStyle}">
                                    <FontIcon FontFamily="Segoe MDL2 Assets" Glyph="&#xE711;" FontSize="16"/>
                                </Button>

                                <TextBlock Text="{x:Bind Id}" HorizontalAlignment="Left" VerticalAlignment="Top" Margin="12,7" Style="{StaticResource BodyStrongTextBlockStyle}"/>
                            </Grid>
                        </controls:ItemContainer>
                    </DataTemplate>
                </controls:ItemsView.ItemTemplate>
                <controls:ItemsView.Layout>
                    <StackLayout Orientation="Horizontal" />
                </controls:ItemsView.Layout>
            </controls:ItemsView>
        </StackPanel>

        <Grid Grid.Column="1" 
            Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" 
            BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
            BorderThickness="1,1,1,0"
            Margin="0,-20,-20,-20"
            Padding="20">

            <Grid MaxWidth="1000">
                <Grid.RowDefinitions>
                    <RowDefinition Height="*" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <ListView
                    x:Name="InvertedListView"
                    Padding="-12,0,-12,24"
                    ItemTemplateSelector="{StaticResource ChatTemplateSelector}"
                    ItemsSource="{x:Bind Messages}"
                    SelectionMode="None"
                    Loaded="InvertedListView_Loaded">
                    <ListView.ItemsPanel>
                        <ItemsPanelTemplate>
                            <ItemsStackPanel VerticalAlignment="Bottom" ItemsUpdatingScrollMode="KeepLastItemInView" />
                        </ItemsPanelTemplate>
                    </ListView.ItemsPanel>
                    <ListView.ItemContainerStyle>
                        <Style TargetType="ListViewItem">
                            <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                        </Style>
                    </ListView.ItemContainerStyle>
                </ListView>
                <Grid Grid.Row="1" ColumnSpacing="8">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <TextBox
                        x:Name="InputBox"
                        Grid.Row="1"
                        AutomationProperties.Name="Prompt input"
                        KeyUp="TextBox_KeyUp"
                        PreviewKeyDown="TextBox_PreviewKeyDown"
                        PlaceholderText="Ask about the sample data"
                        TextChanged="InputBox_TextChanged"
                        TextWrapping="Wrap" 
                        AcceptsReturn="True"
                        MaxHeight="148"
                        ScrollViewer.VerticalScrollBarVisibility="Auto"/>
                    <StackPanel Grid.Column="1" Orientation="Horizontal">
                        <Button x:Name="SendBtn"
                            AutomationProperties.Name="Send Message"
                            Click="SendBtn_Click"
                            Style="{StaticResource AccentButtonStyle}"
                            IsEnabled="False">
                            <FontIcon FontSize="16"
                              Glyph="&#xE725;" />
                        </Button>
                        <Button x:Name="StopBtn"
                            AutomationProperties.Name="Stop"
                            Click="StopBtn_Click"
                            Style="{ThemeResource AccentButtonStyle}"
                            Visibility="Collapsed">
                            <StackPanel Orientation="Horizontal"
                                Spacing="8">
                                <FontIcon FontSize="16"
                                    Glyph="&#xE73B;" />
                                <TextBlock Text="Stop" />
                            </StackPanel>
                        </Button>
                    </StackPanel>

                </Grid>

                <Grid HorizontalAlignment="Stretch" VerticalAlignment="Bottom">
                    <StackPanel Spacing="7">
                        <InfoBar
                            x:Name="IndexingMessage"
                            IsOpen="False"
                            Severity="Informational"
                            Title="Indexing"
                            Message="Partial results may be available." 
                            Padding="0"/>
                        <InfoBar
                            x:Name="RemovedItemMessage"
                            IsOpen="False"
                            Severity="Informational"
                            Message="Item has been removed" 
                            Padding="0"/>
                    </StackPanel>
                </Grid>
            </Grid>
        </Grid>
    </Grid>
</samples:BaseSamplePage>
