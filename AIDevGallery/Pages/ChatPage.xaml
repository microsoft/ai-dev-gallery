<?xml version="1.0" encoding="utf-8" ?>
<Page
    x:Class="AIDevGallery.Pages.ChatPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d">

    <Grid>
        <!-- Initial State: Center input with suggestions -->
        <Grid x:Name="InitialStateGrid" Visibility="Visible">
            <StackPanel 
                HorizontalAlignment="Center" 
                VerticalAlignment="Center"
                Spacing="24"
                MaxWidth="600">
                
                <TextBlock 
                    Text="Hey, what's on your mind today?" 
                    FontSize="32"
                    FontWeight="SemiBold"
                    TextWrapping="Wrap"
                    HorizontalAlignment="Left"/>
                
                <Border 
                    Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                    BorderThickness="1"
                    CornerRadius="8"
                    Padding="16">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        
                        <Button 
                            Grid.Column="0"
                            Margin="0,0,8,0"
                            Width="32"
                            Height="32"
                            Padding="0"
                            ToolTipService.ToolTip="Attach file (Coming soon)"
                            IsEnabled="False">
                            <FontIcon Glyph="&#xE710;" FontSize="16"/>
                        </Button>
                        
                        <TextBox 
                            x:Name="InitialInputBox"
                            Grid.Column="1"
                            PlaceholderText="Message AI"
                            BorderThickness="0"
                            Background="Transparent"
                            VerticalAlignment="Center"/>
                        
                        <Button 
                            Grid.Column="2"
                            Margin="8,0,0,0"
                            Width="32"
                            Height="32"
                            Padding="0"
                            ToolTipService.ToolTip="Voice input (Coming soon)"
                            IsEnabled="False">
                            <FontIcon Glyph="&#xE720;" FontSize="16"/>
                        </Button>
                    </Grid>
                </Border>
                
                <!-- Suggestion Buttons -->
                <StackPanel Spacing="8">
                    <TextBlock 
                        Text="Quick response"
                        FontSize="12"
                        Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                        Margin="0,8,0,0"/>
                    
                <ItemsControl x:Name="SuggestionButtons">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel Orientation="Horizontal" Spacing="8"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Button 
                                    Content="{Binding}" 
                                    Click="SuggestionButton_Click"
                                    Style="{StaticResource SubtleButtonStyle}"
                                    Padding="12,8"
                                    Margin="0,0,8,8"/>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </StackPanel>
        </Grid>

        <!-- Chat State: Top buttons + Messages list + bottom input -->
        <Grid x:Name="ChatStateGrid" Visibility="Collapsed">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>
            
            <!-- Top Action Buttons Bar (full width) -->
            <Grid
                Grid.Row="0"
                Padding="28,16,24,16"
                Background="Transparent">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <!-- Left: Model Selection Button -->
                <Button
                    x:Name="ChatModelBtn"
                    Grid.Column="0"
                    Padding="0"
                    HorizontalAlignment="Left"
                    VerticalAlignment="Center"
                    AutomationProperties.Name="Selected model"
                    Style="{StaticResource SubtleButtonStyle}"
                    IsEnabled="False">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <Border
                            Width="32"
                            VerticalAlignment="Stretch"
                            Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}"
                            BorderBrush="{ThemeResource DividerStrokeColorDefaultBrush}"
                            BorderThickness="0,0,1,0"
                            CornerRadius="4,0,0,4"
                            ToolTipService.ToolTip="Selected model">
                            <FontIcon
                                Margin="2,0,0,0"
                                AutomationProperties.AccessibilityView="Raw"
                                FontSize="14"
                                Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                Glyph="&#xF158;" />
                        </Border>
                        <Grid MinHeight="33" Padding="2,4,10,8" x:Name="ChatModelInfoGrid">
                            <TextBlock
                                x:Name="ChatModelPlaceholder"
                                VerticalAlignment="Center"
                                Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                Text="Select model"
                                Visibility="Visible" />
                            <StackPanel 
                                x:Name="ChatModelInfo"
                                Margin="0,3,0,0"
                                VerticalAlignment="Center"
                                Orientation="Horizontal" 
                                Spacing="8"
                                Visibility="Collapsed">
                                <Image
                                    Width="16"
                                    VerticalAlignment="Center"
                                    Source="ms-appx:///Assets/ModelIcons/HuggingFace.svg" />
                                <TextBlock
                                    Margin="0,-1,0,0"
                                    VerticalAlignment="Center"
                                    Text="Stable Diffusion v1.4" />
                                <Border
                                    Padding="2,0,2,0"
                                    VerticalAlignment="Center"
                                    Background="{ThemeResource TertiaryButtonBackground}"
                                    BorderBrush="{ThemeResource TertiaryButtonBorderBrush}"
                                    BorderThickness="1"
                                    CornerRadius="{StaticResource ControlCornerRadius}">
                                    <TextBlock
                                        VerticalAlignment="Center"
                                        AutomationProperties.AccessibilityView="Raw"
                                        FontSize="10"
                                        Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                        Text="ONNX" />
                                </Border>
                            </StackPanel>
                        </Grid>
                    </StackPanel>
                </Button>
                
                <!-- Right: Code and Export Buttons -->
                <StackPanel
                    Grid.Column="1"
                    HorizontalAlignment="Right"
                    VerticalAlignment="Center"
                    Background="{ThemeResource ControlFillColorDefaultBrush}"
                    BorderBrush="{ThemeResource ControlElevationBorderBrush}"
                    BorderThickness="1"
                    CornerRadius="{StaticResource ControlCornerRadius}"
                    Orientation="Horizontal"
                    Padding="0,1">
                    
                    <!-- Code Button -->
                    <Button
                        x:Name="ChatCodeToggle"
                        Padding="12,6,12,6"
                        VerticalAlignment="Stretch"
                        AutomationProperties.Name="Show source code"
                        Background="Transparent"
                        BorderThickness="0"
                        Click="ChatCodeToggle_Click"
                        ToolTipService.ToolTip="Show source code">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <Viewbox Width="16" Margin="0,-2,0,0">
                                <PathIcon Data="M8.06562 18.9434L14.5656 4.44339C14.7351 4.06542 15.1788 3.89637 15.5568 4.0658C15.9033 4.22112 16.0742 4.60695 15.9698 4.96131L15.9344 5.05698L9.43438 19.557C9.26495 19.935 8.82118 20.104 8.44321 19.9346C8.09673 19.7793 7.92581 19.3934 8.03024 19.0391L8.06562 18.9434L14.5656 4.44339L8.06562 18.9434ZM2.21967 11.4699L6.46967 7.21986C6.76256 6.92696 7.23744 6.92696 7.53033 7.21986C7.7966 7.48612 7.8208 7.90279 7.60295 8.1964L7.53033 8.28052L3.81066 12.0002L7.53033 15.7199C7.82322 16.0127 7.82322 16.4876 7.53033 16.7805C7.26406 17.0468 6.8474 17.071 6.55379 16.8531L6.46967 16.7805L2.21967 12.5305C1.9534 12.2642 1.9292 11.8476 2.14705 11.554L2.21967 11.4699L6.46967 7.21986L2.21967 11.4699ZM16.4697 7.21986C16.7359 6.95359 17.1526 6.92938 17.4462 7.14724L17.5303 7.21986L21.7803 11.4699C22.0466 11.7361 22.0708 12.1528 21.8529 12.4464L21.7803 12.5305L17.5303 16.7805C17.2374 17.0734 16.7626 17.0734 16.4697 16.7805C16.2034 16.5143 16.1792 16.0976 16.3971 15.804L16.4697 15.7199L20.1893 12.0002L16.4697 8.28052C16.1768 7.98762 16.1768 7.51275 16.4697 7.21986Z" />
                            </Viewbox>
                            <TextBlock Margin="0,-1,0,0" Text="Code" />
                        </StackPanel>
                    </Button>
                    
                    <Rectangle
                        Width="1"
                        Margin="0,6"
                        Fill="{ThemeResource DividerStrokeColorDefaultBrush}" />
                    
                    <!-- Export Button -->
                    <Button
                        x:Name="ChatExportToggle"
                        Padding="12,6,12,6"
                        AutomationProperties.Name="Export sample"
                        Click="ChatExportToggle_Click"
                        Style="{StaticResource SubtleButtonStyle}"
                        ToolTipService.ToolTip="Export sample">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <Image Width="16" Source="ms-appx:///Assets/VSIcon.svg" />
                            <TextBlock Margin="0,-1,0,0" Text="Export" />
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Grid>
            
            <!-- Messages ScrollViewer -->
            <ScrollViewer 
                x:Name="MessagesScrollViewer"
                Grid.Row="1" 
                Padding="24">
                <ItemsControl x:Name="MessagesItemsControl">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Grid Margin="0,0,0,16">
                                <!-- User Message -->
                                <Border 
                                    HorizontalAlignment="Right"
                                    Background="{ThemeResource AccentFillColorDefaultBrush}"
                                    CornerRadius="8"
                                    Padding="12"
                                    MaxWidth="600"
                                    Visibility="{Binding IsUserVisibility}">
                                    <TextBlock 
                                        Text="{Binding Text}" 
                                        TextWrapping="Wrap"
                                        Foreground="White"/>
                                </Border>
                                
                                <!-- AI Message -->
                                <StackPanel 
                                    HorizontalAlignment="Left"
                                    MaxWidth="600"
                                    Spacing="8"
                                    Visibility="{Binding IsAssistantVisibility}">
                                    <Border 
                                        Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                        BorderThickness="1"
                                        CornerRadius="8"
                                        Padding="12"
                                        HorizontalAlignment="Left">
                                        <TextBlock 
                                            Text="{Binding Text}" 
                                            TextWrapping="Wrap"/>
                                    </Border>
                                    
                                    <!-- Image if present -->
                                    <Image 
                                        Source="{Binding ImageSource}"
                                        Stretch="Uniform"
                                        MaxHeight="400"
                                        Visibility="{Binding HasImageVisibility}"/>
                                    
                                    <!-- Action Buttons if has actions -->
                                    <StackPanel 
                                        Orientation="Horizontal" 
                                        Spacing="12"
                                        Margin="0,8,0,0"
                                        Visibility="{Binding HasActionsVisibility}">
                                        <Button 
                                            Click="ShowSourceCodeButton_Click"
                                            Style="{StaticResource AccentButtonStyle}">
                                            <StackPanel Orientation="Horizontal" Spacing="8">
                                                <FontIcon Glyph="&#xE943;" FontSize="16"/>
                                                <TextBlock Text="Show Source Code"/>
                                            </StackPanel>
                                        </Button>
                                        <Button 
                                            Click="ExportProjectButton_Click"
                                            Style="{StaticResource AccentButtonStyle}">
                                            <StackPanel Orientation="Horizontal" Spacing="8">
                                                <FontIcon Glyph="&#xE8A7;" FontSize="16"/>
                                                <TextBlock Text="Export VS Project"/>
                                            </StackPanel>
                                        </Button>
                                    </StackPanel>
                                    
                                    <!-- Open Folder Button for exported projects -->
                                    <Button 
                                        Margin="0,8,0,0"
                                        Click="OpenProjectFolderButton_Click"
                                        Tag="{Binding ProjectPath}"
                                        Visibility="{Binding HasOpenFolderButtonVisibility}"
                                        Style="{StaticResource AccentButtonStyle}">
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <FontIcon Glyph="&#xE8DA;" FontSize="16"/>
                                            <TextBlock Text="Open Project Folder"/>
                                        </StackPanel>
                                    </Button>
                                    
                                    <!-- Progress Ring for loading -->
                                    <ProgressRing 
                                        IsActive="{Binding IsLoading}"
                                        Visibility="{Binding IsLoadingVisibility}"
                                        Width="40"
                                        Height="40"/>
                                </StackPanel>
                            </Grid>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>
            
            <!-- Bottom Input -->
            <Border 
                Grid.Row="2"
                Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                BorderThickness="0,1,0,0"
                Padding="24,16">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <TextBox 
                        x:Name="ChatInputBox"
                        Grid.Column="0"
                        PlaceholderText="Type your message..."
                        BorderThickness="1"
                        CornerRadius="4"
                        Padding="12"
                        KeyDown="ChatInputBox_KeyDown"
                        VerticalAlignment="Center"/>
                    
                    <Button 
                        x:Name="SendButton"
                        Grid.Column="1"
                        Content="Send"
                        Click="SendButton_Click"
                        Style="{StaticResource AccentButtonStyle}"
                        Margin="8,0,0,0"
                        VerticalAlignment="Center"/>
                </Grid>
            </Border>
        </Grid>
        
        <!-- License Dialog -->
        <ContentDialog 
            x:Name="LicenseDialog"
            Title="Download model"
            DefaultButton="Primary"
            IsPrimaryButtonEnabled="{Binding ElementName=LicenseCheckBox, Path=IsChecked}"
            PrimaryButtonText="Download"
            CloseButtonText="Cancel"
            PrimaryButtonClick="LicenseDialog_PrimaryButtonClick">
            <StackPanel MinWidth="360">
                <TextBlock TextWrapping="Wrap">
                    <Run Text="You are about to download" />
                    <Run Text="Stable Diffusion v1.4" FontWeight="SemiBold" />
                    <Run Text="from" />
                    <Run Text="Hugging Face" FontWeight="SemiBold" />
                    <LineBreak />
                    <LineBreak /><Run Text="License:" />
                    <Hyperlink NavigateUri="https://huggingface.co/CompVis/stable-diffusion-v1-4">
                        <Run Text="CreativeML Open RAIL-M" />
                    </Hyperlink>
                </TextBlock>
                <CheckBox
                    x:Name="LicenseCheckBox"
                    Margin="0,16,0,0"
                    Content="I have reviewed and agree with the license" />
            </StackPanel>
        </ContentDialog>
    </Grid>
</Page>
